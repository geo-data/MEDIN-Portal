<%inherit file="base-ok.html"/>

<%def name="header()">
    <link href="/css/ui-lightness/jquery-ui-1.8rc3.css" rel="stylesheet" type="text/css" />
    <style type="text/css">
        #map {
            width: 100%;
            height: 400px;
            border: 1px solid #ADACA8;
        }
        #map-holder {
            margin-top: 0.5em;
        }
    </style>
    <script type="text/javascript" src="/js/jquery-1.4.2.js"></script>
    <script type="text/javascript" src="/js/jquery-ui-1.8rc3.js"></script>
    <script type="text/javascript" src="/js/openlayers/OpenLayers.js"></script>
    <script type="text/javascript" src="/js/full/search.js"></script>
    <script type="text/javascript">
        <!--
var map, boxes, box;            // map object, box layer, box marker
%if bbox:
var bbox = new OpenLayers.Bounds(${bbox[0]}, ${bbox[1]}, ${bbox[2]}, ${bbox[3]});
%else:
var bbox = null;
%endif
%if area:
var area = '${area}';
%else:
var area = null;
%endif

function add_box(extent) {
    clear_box();                // remove any previous box

    // add the box to the map
    box = new OpenLayers.Marker.Box(extent);
    bbox = extent;
    boxes.addMarker(box);

    map.zoomToExtent(extent);   // zoom to the box

    $('#bbox').val(extent.toBBOX()); // set the form element
}

// remove the bounding box and deselect the area
function clear_area() {
    var select = $('#area')
    select.val('');
    select.change();
}

function clear_box() {
    if (box) {
        boxes.removeMarker(box);
        box = null;
    }

    $('#bbox').val('');
}

// Populate the area selection control
function populate_areas() {
    var select = $('#area');
    var countries = get_countries();
    for (var i = 0; i < countries.length; i++) {
        var id = countries[i][0];
        var name = countries[i][1];
        select.append('<option value="'+id+'">'+name+'</option>');
    }

    // ensure a bbox is created when an area is selected
    select.change(function() {
        var id = $(this).attr('value');
        var tbbox = get_bbox(id);
        if (!tbbox) {
            clear_box();
            return;
        }

        var extent = new OpenLayers.Bounds(tbbox[0], tbbox[1], tbbox[2], tbbox[3]);
        add_box(extent);
    });

    // if there's an existing area, select it
    if (area) {
        select.val(area);
        select.change();
    } else if (bbox) {
        add_box(bbox);
    }
}

// Initialise the page once loaded
$(function() {
    // initialise the date pickers
    $.datepicker.setDefaults({ dateFormat: 'yy-mm-dd' });
    $('#start-date').datepicker();
    $('#end-date').datepicker();

    // initialise the mapping
    var extent = new OpenLayers.Bounds(-180, -90, 180, 90);
    var options = {
        restrictedExtent: extent,
        maxExtent: extent,
        maxResolution: 360/512
    }
    
    map = new OpenLayers.Map('map', options);
    var layer = new OpenLayers.Layer.TMS( "Bathy", 
                                      "${script_root}/spatial/tms/",
                                      { layername: 'bathymetry', type: 'png' } );
    map.addLayer(layer);
    map.addControl(new OpenLayers.Control.Permalink());

    boxes = new OpenLayers.Layer.Boxes("boxes");
    map.addLayer(boxes);

    if (!bbox) {
        map.setCenter(extent, 1);
    }

    // add the area selections
    populate_areas();
});

        // -->
    </script>
</%def>

<p>Search the MEDIN Data Archive Centres.</p>

<form method="GET" action="${resource_root}/catalogue">
  <fieldset>
    <legend>Search term</legend>
    <input type="text" name="q" size="30"\
  %if search_term:
 value="${search_term}"
  %endif
/> (Leave blank to match everything)
    <div><input type="submit" value="search"/> (<a href="javascript:toggle('search-term-help', 'help', 'hide help')" id="search-term-help-link" title="Show or hide the help">help</a>)</div>
    <div id="search-term-help" style="display: none">
    <p>Words typed in 'as is' will result in a full text search that
    requires all words to be present in matching metadata, e.g.:</p>
    
    <blockquote><div><kbd>aerosol pollution
    troposphere</kbd></div></blockquote>
    
    <p>will find all documents containing <strong>all</strong> of the
    above words.</p>
    
    <p>Words can be excluded from result matches using the
    <strong>minus sign</strong> (<strong>-</strong>) e.g.:</p>
    
    <blockquote><div><kbd><strong>-</strong>aerosol pollution
    <strong>-</strong>troposphere</kbd></div></blockquote>
    
    <p>will find all documents that contain <kbd>pollution</kbd> but
    <strong>not</strong> <kbd>aerosol</kbd> <strong>or</strong>
    <kbd>troposphere</kbd>.</p>
    
    <p>Instead of finding all matching terms, alternative matches can
    be specified using the <strong>pipe character</strong>
    (<strong>|</strong>) e.g.:</p>
    
    <blockquote><div><kbd>aerosol <strong>|</strong> pollution
    troposphere</kbd></div></blockquote>
    
    <p>will find all documents that contain <kbd>troposphere</kbd> and
    <strong>either</strong> <kbd>aerosol</kbd> <strong>or</strong>
    <kbd>pollution</kbd>.</p>
    
    <p>As well as running full text searches, more specific search
    targets can be specified by prefixing words with the target
    identifier.  The identifiers map to the search targets as
    follows:</p>

    <blockquote><div>
      <strong>a</strong>  => Author<br/>
      <strong>p</strong>  => Parameter<br/>
      <strong>rt</strong> => Resource type<br/>
      <strong>tc</strong> => Topic category<br/>
      <strong>l</strong>  => Lineage<br/>
      <strong>al</strong> => Public access limits<br/>
      <strong>o</strong>  => Data originator<br/>
      <strong>f</strong>  => Data format<br/>
    </div></blockquote>
    
    <p>The identifier is separated from the word using a
    <strong>colon</strong> (<strong>:</strong>) e.g.:</p>
    
    <blockquote><div><kbd>aerosol <strong>tc:</strong>pollution
    <strong>p:</strong>troposphere</kbd></div></blockquote>
    
    <p>will match all documents that contain <kbd>aerosol</kbd> that
    also have a <strong>topic category</strong> containing
    <kbd>pollution</kbd> and a <strong>parameter</strong> containing
    <kbd>troposphere</kbd>.</p>
    </div>
  </fieldset>
  <fieldset>
    <legend>Date range</legend>
    <div>Match data that overlaps the period:</div>
    <div> from <input type="text" name="sd" id="start-date" maxlength="10" size="10"\
  %if start_date:
 value="${start_date}"
  %endif
/> to 
     <input type="text" name="ed" id="end-date" maxlength="10" size="10"\
  %if end_date:
 value="${end_date}"
  %endif
/> (Dates should be in the format <strong>YYYY-MM-DD</strong>)</div>
    <div><input type="submit" value="search"/></div>
  </fieldset>

  %if sort:
  <input name="s" type="hidden" value="${sort}" />
  %endif
  %if count:
  <input name="c" type="hidden" value="${count}" />
  %endif
  <input name="bbox" id="bbox" type="hidden" value="\
  %if bbox:
${','.join(bbox)}\
  %endif
" />

  <fieldset>
    <legend>Geographic search</legend>
    <select name="a" id="area">
      <option value="">Select an area...</option>
    </select>
    <button type="button" onclick="javascript:clear_area()">Clear area</button>
    <div><input type="submit" value="search"/></div>
    <div id="map-holder">
      <div id="map"></div>
    </div>
  </fieldset>
</form>