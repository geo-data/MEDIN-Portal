<%namespace import="search_criteria" file="search-common.html"/>
<%inherit file="base-ok.html"/>

<%def name="header()">
    <style type="text/css">
        #map {
            /* it is important to assign absolute pixel sizes for IE
            in map divs that are initially hidden (see
            http://stackoverflow.com/questions/1081812/javascript-unspecified-error-in-open-layers) */
            width: 400px;
            height: 400px;
            border: 1px solid #ADACA8;
        }
        #map-holder {
            margin-top: 0.5em;
        }
    </style>
    <script type="text/javascript" src="/js/jquery.iclick.js"></script>
    <script type="text/javascript" src="/js/jquery.alignwith.js"></script>
    <script type="text/javascript" src="/js/jquery.ba-resize.js"></script>
    <script type="text/javascript" src="/js/openlayers/OpenLayers.js"></script>
    <script type="text/javascript" src="/js/full/search.js"></script>
    <script type="text/javascript">
        <!--
var map;            // map object
%if bbox:
var bbox = new OpenLayers.Bounds(${bbox[0]}, ${bbox[1]}, ${bbox[2]}, ${bbox[3]});
%else:
var bbox = null;
%endif
%if area:
var area = '${area}';
%else:
var area = null;
%endif
var script_root = '${script_root}';

// Initialise the page once loaded
$(function() {
    OpenLayers.ProxyHost="${script_root}/proxy?url=";
    
    %if not area and not bbox:
	// initialise the tooltips
	init_tool_tips();
	%endif
	
    // initialise the date pickers
    $.datepicker.setDefaults({ dateFormat: 'yy-mm-dd' });
    init_date('start-date');
    init_date('end-date');

    // add the user input checks to the form so that when input is
    // updated it is checked on the server.
    $('#search-form input[type=text]:not(#bbox)').change(function() {
        check_query();
    });
});

        // -->
    </script>
</%def>

<%def name="left_menu()">\
<div id="menu-contents">&nbsp;
  <div class="info">
    ${search_criteria()}
    <p><a href="${resource_root}" title="Clear this search and start again">Start a new search</a>.</p>
  </div>
  <div class="info info-sibling">
    <h3>Shortcut search</h3>
    <div>Click to search...</div>
    <ul>
      <li><a title="Search" href="${resource_root}/areas/countries/united%20kingdom">The United Kingdom</a></li>
      <li><a title="Search" href="${resource_root}/areas/countries/england">England</a></li>
      <li><a title="Search" href="${resource_root}/areas/countries/scotland">Scotland</a></li>
      <li><a title="Search" href="${resource_root}/areas/countries/wales">Wales</a></li>
      <li><a title="Search" href="${resource_root}/areas/countries/northern%20ireland">Northern Ireland</a></li>
    </ul>
  </div>
</div>
</%def>

<%def name="area_selection(area_id)">\
    %for id, name in area_ids[area_id]:
<option value="${id}"\
  %if area == id:
 selected="selected"\
  %endif
>${name | x}</option>
    %endfor
</%def>

<form id="search-form" method="get" action="${resource_root}/catalogue">
  <fieldset id="text-search">
    <legend><a href="javascript:toggle_fieldset('text-search')" title="Show or hide the text search">Search term</a></legend>
    <div class="content">
      <input type="text" name="q" size="30"\
      %if search_term:
 value="${search_term}"\
      %endif
/> <input type="submit" value="search"/>
      <div>Leave blank to match everything. (<a href="javascript:toggle('search-term-help', 'help', 'hide help')" id="search-term-help-link" title="Show or hide the help">help</a>)</div>
      <div id="search-term-help" style="display: none">
      <p>Words typed in 'as is' will result in a full text search that
      requires all words to be present in matching metadata, e.g.:</p>
      
      <blockquote><div><kbd>acoustic currents
      sediment</kbd></div></blockquote>
      
      <p>will find all documents containing <strong>all</strong> of the
      above words.</p>
      
      <p>Words can be excluded from result matches using the
      <strong>minus sign</strong> (<strong>-</strong>) e.g.:</p>
      
      <blockquote><div><kbd><strong>-</strong>acoustic currents
      <strong>-</strong>sediment</kbd></div></blockquote>
      
      <p>will find all documents that contain <kbd>currents</kbd> but
      <strong>not</strong> <kbd>acoustic</kbd> <strong>or</strong>
      <kbd>sediment</kbd>.</p>
      
      <p>Instead of finding all matching terms, alternative matches can
      be specified using the word <strong>OR</strong>
      (in capitals) e.g.:</p>
      
      <blockquote><div><kbd>acoustic <strong>OR</strong> currents
      sediment</kbd></div></blockquote>
      
      <p>will find all documents that contain <kbd>sediment</kbd> and
      <strong>either</strong> <kbd>acoustic</kbd> <strong>or</strong>
      <kbd>currents</kbd>.</p>
      
      <p>As well as running full text searches, more specific search
      targets can be specified by prefixing words with a target
      identifier.  Available target identifiers and how they relate to
      search fields are as follows:</p>
      
      <blockquote><div>
        <strong>a</strong>  => Author<br/>
        <strong>p</strong>  => Parameter<br/>
        <strong>rt</strong> => Resource type<br/>
        <strong>tc</strong> => Topic category<br/>
        <strong>l</strong>  => Lineage<br/>
        <strong>al</strong> => Public access limits<br/>
        <strong>o</strong>  => Data originator<br/>
        <strong>f</strong>  => Data format<br/>
      </div></blockquote>
      
      <p>The identifier is separated from the word using a
      <strong>colon</strong> (<strong>:</strong>) e.g.:</p>
      
      <blockquote><div><kbd>acoustic <strong>tc:</strong>oceans
      <strong>p:</strong>sediment</kbd></div></blockquote>
      
      <p>will match all documents that contain <kbd>acoustic</kbd> that
      also have a <strong>topic category</strong> containing
      <kbd>oceans</kbd> and a <strong>parameter</strong> containing
      <kbd>sediment</kbd>.</p>
      </div>
    </div>
    
    %if sort:
    <input name="s" type="hidden" value="${sort}" />
    %endif
    %if count:
    <input name="c" type="hidden" value="${count}" />
    %endif    
  </fieldset>
  <fieldset id="date-search"\
    %if not start_date and not end_date:
 class="off"\
    %endif
>
    <legend><a href="javascript:toggle_fieldset('date-search')" title="Show or hide the date range">Date range</a></legend>
    <div class="content"\
    %if not start_date and not end_date:
 style="display:none"\
    %endif
>

      <div>Match data that overlaps the period:</div>
      <div> from <a id="start-date-text" href="#" title="Specify a start date"\
    %if start_date:
 style="display:none"\
    %endif
>the earliest record</a><input type="text" name="sd" id="start-date" maxlength="10" size="10"\
    %if start_date:
 value="${start_date}"\
    %else:
 style="display:none"\
    %endif
  /> to <a id="end-date-text" href="#" title="Specify an end date"\
    %if end_date:
 style="display:none"\
    %endif
>the latest record</a><input type="text" name="ed" id="end-date" maxlength="10" size="10"\
    %if end_date:
 value="${end_date}"\
    %else:
 style="display:none"\
    %endif
  /> <input type="submit" value="search"/></div>
      <div>Dates should either be in the format <strong>YYYY-MM-DD</strong> or <strong>YYYY</strong>.</div>
    </div>
  </fieldset>

  <fieldset id="spatial-search">
    <legend><a href="javascript:toggle_fieldset('spatial-search')" title="Show or hide the geographic search">Geographic search</a></legend>
    %if not area and not bbox:
	<div class="content" id="spatial-search-holder">
	  <a href="javascript:init_spatial_search()"><img id="spatial-start" class="image_no_border" src="/images/earth-from-space.jpg" width="90" height="90" alt="Geographical search"/></a>
	  <div id="spatial-start-tip" class="tooltip"><img class="tooltip-arrow" src="/images/tooltip-arrow.png"/><span class="tooltip-text">Click on the globe to start a geographic search</span></div>
	</div>
    %endif
    <div id="spatial-search-content"\
    %if not area and not bbox:
 style="display:none"\
    %else:
 class="content"\
    %endif
>
      <div>
        <div>
          <select name="t" id="area-type">
            %for id, name in (('co', 'Countries'), ('sa', 'SeaVoX Salt and Fresh Water Body Gazetteer'), ('cp', 'UK Charting Progress Sea Areas'), ('ir', 'ICES Rectangles')):
            <option value="${id}"\
              %if area_type == id:
 selected="selected"\
              %endif
>${name | x}</option>
            %endfor
          </select>
        </div>
        <select class="area" id="co"\
          %if not area_type or area_type == 'co':
 name="a"\
          %else:
 style="display: none"\
          %endif
>
          <option value="">Select a country...</option>
          <optgroup id="british-isles" label="British Isles">
${area_selection('british-isles')}
          </optgroup>
          <optgroup id="countries" label="Countries">
${area_selection('countries')}
          </optgroup>
        </select>
        <select class="area" id="sa"\
          %if area_type == 'sa':
 name="a"\
          %else:
 style="display: none"\
          %endif
>
          <option value="">Select a sea area...</option>
${area_selection('sea-areas')}
        </select>
        <select class="area" id="cp"\
          %if area_type == 'cp':
 name="a"\
          %else:
 style="display: none"\
          %endif
>
          <option value="">Select a progress area...</option>
${area_selection('progress-areas')}
        </select>
        <select class="area" id="ir"\
          %if area_type == 'ir':
 name="a"\
          %else:
 style="display: none"\
          %endif
>
          <option value="">Select an ICES area...</option>
${area_selection('ices-rectangles')}
        </select>
        <input type="submit" value="search"/>
        <input type="button" onclick="javascript:clear_area()" value="clear area"/>
      </div>
      <div>Create a <strong>new box</strong> by dragging the mouse whilst holding down the <kbd>CTRL</kbd> key. Click the box to finish.</div>
      <div>Click on an <strong>existing box</strong> to <strong>resize or drag</strong> it. Click the box again to finish. (<a href="javascript:toggle('spatial-search-help', 'help', 'hide help')" id="spatial-search-help-link" title="Show or hide the help">help</a>)</div>
      <div id="spatial-search-help" style="display: none">
      <h3>Define bounding boxes</h3>
      <p>Creating a bounding box restricts results to data which
      intersects with the box. In addition to using the predefined
      areas you can create your own.</p>

      <p>Create a <strong>new box</strong> by holding down the
      <kbd>CTRL</kbd> key whilst dragging the mouse over the map using
      the left mouse button. Releasing the button creates the box and
      lets you <strong>resize it using the handles</strong> on the box
      or <strong>reposition it by dragging</strong>. Click the box to
      finish it and return to normal map navigation mode.</p>

      <p>An <strong>existing box</strong> can be resized by clicking
      it to enter edit mode. The resize handles will appear in the box
      corners and the box can also be dragged to a new
      position. Clicking the box again returns you to normal map
      navigation mode.</p>
      
      <h3>Navigate the map</h3>
      <p>As well as using the visible navigation icons on the map you
      can also navigate using the mouse. Left-clicking the mouse and
      dragging will let you <strong>pan the map</strong>. If you have
      a mouse-wheel you can use this to <strong>zoom in or
      out</strong>. Holding down the <kbd>SHIFT</kbd> key whilst
      dragging the map lets you <strong>zoom into a specific
      area</strong>.</p>
      </div>
      <div id="map-holder">
        <div id="map"></div>
      </div>
      <h3>Edit the search box coordinates</h3>
      <input size="38" name="bbox" id="bbox" type="text" value="\
    %if bbox:
  ${','.join(map(str, bbox))}\
    %endif
" />
      <input type="submit" value="search"/>
      <div>Coordinates should use decimal degrees in the format <strong>West,South,East,North</strong>.</div>
    </div>
  </fieldset>
</form>
